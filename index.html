<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì∏ image ‚Üí docx ¬∑ one‚Äëfile app</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
        }
        body {
            background: linear-gradient(145deg, #f6f9fc 0%, #e9f2f9 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            margin: 0;
        }
        .card {
            max-width: 1000px;
            width: 100%;
            background: rgba(255,255,255,0.75);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-radius: 2.5rem;
            box-shadow: 0 20px 40px -10px rgba(0,20,40,0.25), 0 8px 20px rgba(0,0,0,0.1);
            padding: 2.5rem 2rem;
            border: 1px solid rgba(255,255,255,0.5);
            transition: all 0.2s ease;
        }
        h1 {
            font-size: 2.4rem;
            font-weight: 600;
            letter-spacing: -0.02em;
            color: #0b2b3b;
            display: flex;
            align-items: center;
            gap: 0.7rem;
            margin-bottom: 0.2rem;
            border-left: 7px solid #2b7a8a;
            padding-left: 1.3rem;
        }
        h1 span {
            background: #1f5f6e;
            color: white;
            font-size: 0.9rem;
            font-weight: 500;
            padding: 0.2rem 1rem;
            border-radius: 40px;
            letter-spacing: normal;
            margin-left: 0.5rem;
        }
        .sub {
            color: #2d5a6b;
            font-size: 1.1rem;
            margin-bottom: 2rem;
            margin-top: 0.2rem;
            padding-left: 2rem;
            opacity: 0.85;
        }
        .grid-converter {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.8rem;
            margin: 2rem 0 1.2rem;
        }
        .panel {
            background: white;
            border-radius: 1.8rem;
            padding: 1.8rem 1.5rem 2rem;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.02), 0 10px 20px -12px #0b2f3f;
            border: 1px solid #dbeaf0;
        }
        .panel h2 {
            font-size: 1.4rem;
            font-weight: 500;
            margin: 0 0 1.2rem 0;
            color: #1a4c5c;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border-bottom: 2px dashed #aac9d5;
            padding-bottom: 0.7rem;
        }
        .upload-area {
            border: 2px dashed #7fa9b9;
            background: #f1faff;
            border-radius: 2rem;
            padding: 2.2rem 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: background 0.2s, border-color 0.2s;
            margin-bottom: 1.6rem;
        }
        .upload-area:hover {
            background: #e3f2fa;
            border-color: #2b7a8a;
        }
        .upload-area svg {
            width: 48px;
            height: 48px;
            stroke: #1f5f6e;
            stroke-width: 1.3;
            fill: none;
            margin-bottom: 0.5rem;
        }
        .upload-area p {
            font-size: 1rem;
            color: #144a57;
            font-weight: 500;
        }
        .upload-area small {
            color: #537784;
            font-size: 0.85rem;
        }
        .preview-box {
            background: #d9e7ef40;
            border-radius: 1.4rem;
            padding: 1.2rem;
            text-align: center;
        }
        .preview-box img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 1.2rem;
            box-shadow: 0 8px 18px -8px rgba(0,40,50,0.3);
            background: #fff;
            object-fit: contain;
        }
        .filename {
            font-size: 0.9rem;
            color: #1a4c5c;
            margin-top: 0.5rem;
            font-weight: 500;
            background: #c9dde8;
            display: inline-block;
            padding: 0.2rem 1.2rem;
            border-radius: 30px;
        }
        .docx-settings {
            display: flex;
            flex-direction: column;
            gap: 1.8rem;
        }
        .option-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: #eef5f9;
            padding: 0.8rem 1.4rem;
            border-radius: 3rem;
        }
        .option-row label {
            font-weight: 550;
            color: #0d3d4b;
            min-width: 90px;
        }
        .option-row input, .option-row select {
            background: white;
            border: 1px solid #aac2ce;
            border-radius: 2rem;
            padding: 0.5rem 1.2rem;
            font-size: 0.95rem;
            color: #0b2b3b;
            outline: none;
            flex: 1;
        }
        .option-row input:focus, .option-row select:focus {
            border-color: #2b7a8a;
            box-shadow: 0 0 0 2px #b3dbe8;
        }
        .dimension-hint {
            font-size: 0.85rem;
            color: #4b6f7c;
            margin-left: 1rem;
        }
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: space-between;
            align-items: center;
            margin: 1rem 0 0.5rem;
        }
        .btn {
            border: none;
            background: white;
            padding: 0.85rem 2.2rem;
            border-radius: 3rem;
            font-weight: 600;
            font-size: 1.05rem;
            box-shadow: 0 4px 10px rgba(27, 79, 92, 0.2);
            color: #144a57;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: 0.15s;
            border: 1px solid transparent;
        }
        .btn-primary {
            background: #1b5f6e;
            color: white;
            box-shadow: 0 8px 16px -6px #1b5f6e80;
        }
        .btn-primary:hover {
            background: #0f4a58;
            transform: scale(1.02);
        }
        .btn:active {
            transform: scale(0.98);
        }
        .btn:disabled {
            opacity: 0.4;
            pointer-events: none;
            filter: grayscale(0.5);
        }
        .status {
            background: #dff0f6;
            padding: 0.8rem 1.5rem;
            border-radius: 3rem;
            font-size: 0.95rem;
            color: #1a4c5c;
            display: flex;
            align-items: center;
            gap: 0.8rem;
            border: 1px solid #bbd3de;
            margin-top: 1.8rem;
        }
        .status .spinner {
            width: 22px;
            height: 22px;
            border: 3px solid #aac2ce;
            border-top: 3px solid #1b5f6e;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .footer-note {
            margin-top: 1.7rem;
            text-align: center;
            color: #4d707e;
            font-size: 0.9rem;
        }
        hr {
            border: none;
            height: 1px;
            background: linear-gradient(to right, transparent, #aac2ce, transparent);
            margin: 1.2rem 0 0.5rem;
        }
        /* responsive */
        @media (max-width: 700px) {
            .grid-converter { grid-template-columns: 1fr; }
            .card { padding: 1.5rem; }
            h1 { font-size: 2rem; }
        }
    </style>
</head>
<body>
<div class="card">
    <h1>
        üñºÔ∏è ‚Üí üìÑ image to Word
        <span>docx</span>
    </h1>
    <div class="sub">drop an image, customise layout, download .docx</div>

    <div class="grid-converter">
        <!-- left panel: image input & preview -->
        <div class="panel">
            <h2>üìé 1. choose image</h2>
            <div class="upload-area" id="dropZone">
                <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                    <polyline points="17 8 12 3 7 8" />
                    <line x1="12" y1="3" x2="12" y2="15" />
                </svg>
                <p><strong>click or drag image here</strong></p>
                <small>PNG, JPG, WebP up to 15 MB</small>
            </div>
            <input type="file" id="fileInput" accept="image/png, image/jpeg, image/webp, image/jpg" style="display: none;">

            <!-- preview area -->
            <div class="preview-box" id="previewContainer" style="display: none;">
                <img id="previewImg" src="#" alt="preview">
                <div class="filename" id="fileNameDisplay"></div>
            </div>
            <div style="margin-top: 1rem; font-size:0.9rem; color: #2f5f6e;" id="imageDimensions"></div>
        </div>

        <!-- right panel: docx options + convert -->
        <div class="panel">
            <h2>‚öôÔ∏è 2. word settings</h2>
            <div class="docx-settings">
                <div class="option-row">
                    <label>page size</label>
                    <select id="pageSizeSelect">
                        <option value="A4" selected>A4 (210mm x 297mm)</option>
                        <option value="Letter">Letter (8.5"x11")</option>
                        <option value="Legal">Legal (8.5"x14")</option>
                    </select>
                </div>
                <div class="option-row">
                    <label>orientation</label>
                    <select id="orientationSelect">
                        <option value="portrait" selected>Portrait</option>
                        <option value="landscape">Landscape</option>
                    </select>
                </div>
                <div class="option-row">
                    <label>image width</label>
                    <input type="number" id="imgWidthInput" value="6" min="2" max="15" step="0.1">
                    <span class="dimension-hint">inches</span>
                </div>
                <div class="option-row">
                    <label>alignment</label>
                    <select id="alignSelect">
                        <option value="left">Left</option>
                        <option value="center" selected>Center</option>
                        <option value="right">Right</option>
                    </select>
                </div>
                <div class="option-row">
                    <label>caption</label>
                    <input type="text" id="captionInput" placeholder="e.g. Figure 1: my image" value="Inserted image">
                </div>
            </div>
        </div>
    </div>

    <!-- action row -->
    <div class="action-buttons">
        <button class="btn" id="clearBtn">üóëÔ∏è clear</button>
        <button class="btn btn-primary" id="convertBtn" disabled>üì• create & download .docx</button>
    </div>

    <!-- status & messages -->
    <div class="status" id="statusMsg">
        <span>‚è≥</span> <span id="statusText">waiting for an image</span>
    </div>
    <hr>
    <div class="footer-note">‚ú® image will be embedded directly in the Word document (base64). no upload, pure client‚Äëside.</div>
</div>

<!-- include JSZip and docx library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.5.0/docx.umd.min.js"></script>
<script>
    (function() {
        // --- dom elements ---
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const previewContainer = document.getElementById('previewContainer');
        const previewImg = document.getElementById('previewImg');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        const imageDimensionsSpan = document.getElementById('imageDimensions');
        const convertBtn = document.getElementById('convertBtn');
        const clearBtn = document.getElementById('clearBtn');
        const statusTextEl = document.getElementById('statusText');
        const statusMsgDiv = document.getElementById('statusMsg');

        // input fields
        const pageSizeSelect = document.getElementById('pageSizeSelect');
        const orientationSelect = document.getElementById('orientationSelect');
        const imgWidthInput = document.getElementById('imgWidthInput');
        const alignSelect = document.getElementById('alignSelect');
        const captionInput = document.getElementById('captionInput');

        // --- state ---
        let currentImageFile = null;
        let imageDataBase64 = null;   // raw base64 (without prefix)
        let imageMimeType = '';
        let naturalWidth = 0, naturalHeight = 0;
        let objectUrl = null;

        // --- helpers ---
        function updateStatus(emoji, text, isLoading = false) {
            statusTextEl.innerText = text;
            statusMsgDiv.innerHTML = `<span>${emoji}</span> <span id="statusText">${text}</span>`;
            if (isLoading) {
                statusMsgDiv.innerHTML = `<span class="spinner"></span> <span id="statusText">${text}</span>`;
            }
        }

        function resetPreviewAndDisable() {
            if (objectUrl) {
                URL.revokeObjectURL(objectUrl);
                objectUrl = null;
            }
            currentImageFile = null;
            imageDataBase64 = null;
            previewContainer.style.display = 'none';
            previewImg.src = '';
            fileNameDisplay.innerText = '';
            imageDimensionsSpan.innerText = '';
            convertBtn.disabled = true;
            updateStatus('üï≥Ô∏è', 'no image loaded');
        }

        // --- convert uploaded file to base64, extract dimensions ---
        function processImageFile(file) {
            if (!file.type.match('image.*')) {
                alert('‚ùå not an image ‚Äî please select a valid image');
                resetPreviewAndDisable();
                return;
            }
            if (file.size > 15 * 1024 * 1024) {
                alert('image is larger than 15 MB, please choose a smaller file');
                resetPreviewAndDisable();
                return;
            }

            currentImageFile = file;
            fileNameDisplay.innerText = file.name;

            // revoke old preview url
            if (objectUrl) URL.revokeObjectURL(objectUrl);
            objectUrl = URL.createObjectURL(file);
            previewImg.src = objectUrl;
            previewContainer.style.display = 'block';

            // get natural size once loaded
            previewImg.onload = function() {
                naturalWidth = previewImg.naturalWidth;
                naturalHeight = previewImg.naturalHeight;
                imageDimensionsSpan.innerText = `üìê ${naturalWidth} x ${naturalHeight} px`;
                previewImg.onload = null;
            };

            // convert to base64
            const reader = new FileReader();
            reader.onload = function(e) {
                const base64Full = e.target.result;  // "data:image/png;base64,...."
                const commaIdx = base64Full.indexOf(',');
                if (commaIdx > 0) {
                    imageMimeType = base64Full.substring(5, commaIdx); // "image/png"
                    imageDataBase64 = base64Full.substring(commaIdx + 1);
                } else {
                    // fallback: treat as full
                    imageDataBase64 = btoa(unescape(encodeURIComponent(base64Full))); // risky but rare
                    imageMimeType = 'image/png';
                }
                // enable convert button if base64 ok
                if (imageDataBase64 && imageDataBase64.length > 0) {
                    convertBtn.disabled = false;
                    updateStatus('üìå', `image ready ¬∑ ${(file.size / 1024).toFixed(0)} kb`);
                } else {
                    updateStatus('‚ö†Ô∏è', 'base64 conversion failed');
                }
            };
            reader.onerror = function() {
                alert('error reading file');
                resetPreviewAndDisable();
            };
            reader.readAsDataURL(file);
        }

        // --- clear action ---
        clearBtn.addEventListener('click', function() {
            fileInput.value = '';
            resetPreviewAndDisable();
            // reset to default settings (optional)
            pageSizeSelect.value = 'A4';
            orientationSelect.value = 'portrait';
            imgWidthInput.value = '6';
            alignSelect.value = 'center';
            captionInput.value = 'Inserted image';
        });

        // --- drop zone & click ---
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => e.preventDefault());
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            const file = e.dataTransfer.files[0];
            if (file) {
                processImageFile(file);
                // sync file input for consistency
                const dt = new DataTransfer();
                dt.items.add(file);
                fileInput.files = dt.files;
            }
        });

        fileInput.addEventListener('change', function() {
            if (fileInput.files.length > 0) {
                processImageFile(fileInput.files[0]);
            } else {
                resetPreviewAndDisable();
            }
        });

        // --- main conversion: build docx and trigger download ---
        async function buildAndDownloadDocx() {
            if (!imageDataBase64 || !currentImageFile) {
                alert('no image loaded');
                return;
            }

            // gather options
            const pageSize = pageSizeSelect.value;
            const orientation = orientationSelect.value;
            const widthInches = parseFloat(imgWidthInput.value) || 6;
            const alignment = alignSelect.value;
            const captionText = captionInput.value.trim() || ' ';

            // compute page dimensions in twips (1/1440 inch) for docx, but docx uses twips? Actually docx library uses twentieths of a point (dxa). 1 inch = 72 points = 1440 twips.
            // but docx lib expects page size in twips? Using predefined enums. Let's map cleanly.
            const pageOrientation = orientation === 'portrait' ? 'portrait' : 'landscape';

            let pageWidth, pageHeight;
            if (pageSize === 'A4') {
                pageWidth = 11906;   // 210mm in twips (approx)
                pageHeight = 16838;  // 297mm
            } else if (pageSize === 'Letter') {
                pageWidth = 12240;    // 8.5in * 1440
                pageHeight = 15840;   // 11in * 1440
            } else { // Legal
                pageWidth = 12240;    // 8.5in
                pageHeight = 20160;   // 14in *1440
            }

            if (orientation === 'landscape') {
                [pageWidth, pageHeight] = [pageHeight, pageWidth];
            }

            // width in EMU (English Metric Units) ‚Äì docx works with EMU for images: 1 inch = 914400 EMU
            const widthEmu = Math.round(widthInches * 914400);
            // keep aspect ratio from original image
            if (naturalWidth === 0) {
                // fallback: if dimensions not yet loaded (should be loaded by now, but safety)
                naturalWidth = 800; naturalHeight = 600; 
            }
            const aspect = naturalHeight / naturalWidth;
            const heightEmu = Math.round(widthEmu * aspect);

            // alignment mapping
            let alignOption;
            if (alignment === 'left') alignOption = docx.AlignmentType.LEFT;
            else if (alignment === 'right') alignOption = docx.AlignmentType.RIGHT;
            else alignOption = docx.AlignmentType.CENTER;

            try {
                updateStatus('‚è≥', 'building document...', true);
                convertBtn.disabled = true;

                // create image buffer from base64
                const imageBuffer = Uint8Array.from(atob(imageDataBase64), c => c.charCodeAt(0));

                // Build docx using docx library
                const { Document, Packer, Paragraph, ImageRun, AlignmentType, PageOrientation, WidthType } = docx;

                // Prepare image run
                const imageRun = new ImageRun({
                    data: imageBuffer,
                    transformation: {
                        width: widthEmu,
                        height: heightEmu,
                    },
                    type: imageMimeType === 'image/png' ? 'png' : 'jpeg', // approximate (jpg / png)
                });

                // Create paragraph with image
                const imageParagraph = new Paragraph({
                    children: [imageRun],
                    alignment: alignOption,
                });

                // Optional caption paragraph
                const captionParagraph = new Paragraph({
                    children: [{
                        text: captionText,
                        italics: true,
                        size: 24,  // half-points ‚Üí 12pt
                        color: '2F4F4F',
                    }],
                    alignment: alignOption,
                    spacing: { before: 120, after: 240 },
                });

                // Build document
                const doc = new Document({
                    sections: [{
                        properties: {
                            page: {
                                pageWidth: pageWidth,
                                pageHeight: pageHeight,
                                orientation: orientation === 'landscape' ? PageOrientation.LANDSCAPE : PageOrientation.PORTRAIT,
                            },
                        },
                        children: [imageParagraph, captionParagraph],
                    }],
                });

                // generate blob
                const blob = await Packer.toBlob(doc);

                // trigger download
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = currentImageFile.name.replace(/\.[^/.]+$/, '') + '.docx';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);

                updateStatus('‚úÖ', 'docx downloaded successfully!');
                convertBtn.disabled = false; // re-enable (still image loaded)
            } catch (err) {
                console.error(err);
                alert('error creating document: ' + err.message);
                updateStatus('‚ùå', 'conversion failed');
                convertBtn.disabled = false;
            }
        }

        convertBtn.addEventListener('click', buildAndDownloadDocx);

        // initial reset
        resetPreviewAndDisable();

        // if user wants to re-run after download, button enabled, keep image.
        // edge: ensure dimensions after load
    })();
</script>
</body>
</html>